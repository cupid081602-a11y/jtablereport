<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>김포공항 정테이블 일일 매출 보고서</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js for data visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- XLSX.js for Excel file reading -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, addDoc, getDocs, orderBy, limit, serverTimestamp, setLogLevel, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore 디버그 로깅 활성화
        setLogLevel('debug');

        // Firestore 전역 변수 설정
        window.db = null;
        window.auth = null;
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.userId = null;
        window.allSalesData = [];
        window.menuCategoryMap = {};

        // Firebase 설정. 이 값들은 자동으로 주입되므로 별도 수정이 필요하지 않습니다.
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        
        // 로딩 화면 표시 함수
        window.showLoader = function(message) {
            const loader = document.getElementById('loader-container');
            const loaderMessage = document.getElementById('loader-message');
            if (loader && loaderMessage) {
                loaderMessage.textContent = message;
                loader.classList.remove('hidden');
            }
        };

        // 로딩 화면 숨기기 함수
        window.hideLoader = function() {
            const loader = document.getElementById('loader-container');
            if (loader) {
                loader.classList.add('hidden');
            }
        };

        // 메시지 표시 함수
        window.showMessage = function(message, bgColor) {
            const messageBox = document.getElementById('message-box');
            if (messageBox) {
                messageBox.textContent = message;
                messageBox.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg text-white font-bold transition-opacity duration-500 ${bgColor}`;
                messageBox.style.opacity = 1;
                
                setTimeout(() => {
                    messageBox.style.opacity = 0;
                }, 3000);
            }
        };
        
        // 카테고리 맵을 Firestore에서 불러오는 함수
        async function fetchMenuCategoryMap() {
            if (!window.userId) {
                console.error("userId가 정의되지 않았습니다. 카테고리 맵을 불러올 수 없습니다.");
                return;
            }
            try {
                // 경로를 사용자 전용 경로로 변경
                const docRef = doc(window.db, "artifacts", window.appId, "users", window.userId, "menu_categories", "map");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    window.menuCategoryMap = docSnap.data().categories || {};
                    console.log("카테고리 맵 불러오기 성공:", window.menuCategoryMap);
                } else {
                    console.log("카테고리 맵이 존재하지 않습니다. 기본값 설정.");
                    window.menuCategoryMap = { '식사류': [], '음료류': [], '주류': [], '기타': [] };
                }
            } catch (e) {
                console.error("카테고리 맵 불러오기 오류:", e);
                window.menuCategoryMap = { '식사류': [], '음료류': [], '주류': [], '기타': [] };
            }
        }

        // 카테고리 맵을 Firestore에 저장하는 함수
        async function saveMenuCategoryMap() {
            if (!window.db || !window.userId) {
                console.error("Firebase 또는 userId가 초기화되지 않았습니다.");
                return;
            }
            try {
                // 경로를 사용자 전용 경로로 변경
                const docRef = doc(window.db, "artifacts", window.appId, "users", window.userId, "menu_categories", "map");
                await setDoc(docRef, { categories: window.menuCategoryMap });
                console.log("카테고리 맵 저장 성공.");
                showMessage('카테고리가 성공적으로 저장되었습니다.', 'bg-green-500');
            } catch (e) {
                console.error("카테고리 맵 저장 오류:", e);
                showMessage('카테고리 저장 중 오류가 발생했습니다.', 'bg-red-500');
            }
        }

        // 모든 업로드 데이터 삭제 함수
        window.deleteUploadedData = async function() {
            if (!window.db || !window.userId) {
                console.error("Firebase 또는 userId가 초기화되지 않았습니다.");
                return;
            }

            try {
                window.showLoader('데이터를 삭제하는 중입니다...');
                // 경로를 사용자 전용 경로로 변경
                const q = query(collection(window.db, "artifacts", window.appId, "users", window.userId, "sales_data"));
                const querySnapshot = await getDocs(q);

                const deletePromises = querySnapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);

                // 카테고리 맵 초기화
                window.menuCategoryMap = { '식사류': [], '음료류': [], '주류': [], '기타': [] };
                await saveMenuCategoryMap();

                showMessage('모든 업로드 데이터가 삭제되었습니다.', 'bg-green-500');
                
            } catch (e) {
                console.error("데이터 삭제 오류:", e);
                showMessage('데이터 삭제 중 오류가 발생했습니다.', 'bg-red-500');
            } finally {
                window.hideLoader();
                closeModal('confirm-delete-modal');
            }
        };


        // 인증 및 데이터 로딩 시작
        async function initApp() {
            window.showLoader('사용자 인증 중...');
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
                
                // onAuthStateChanged 콜백 내에서 모든 Firestore 작업을 시작
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                        console.log("Firebase initialized and authenticated with user ID:", window.userId);
                        await fetchMenuCategoryMap();
                        startDataListener();
                    } else {
                        console.log("User is signed out or not authenticated.");
                        window.userId = crypto.randomUUID();
                        await fetchMenuCategoryMap();
                        startDataListener();
                    }
                });

            } catch (error) {
                console.error("Firebase 인증 오류:", error);
                window.hideLoader();
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    loadingEl.textContent = '인증 오류: 데이터를 불러올 수 없습니다.';
                    loadingEl.style.display = 'block';
                }
            }
        }
        
        // Firestore 데이터 변경 감지 리스너 (공유 데이터로 변경)
        function startDataListener() {
            window.showLoader('데이터를 불러오는 중입니다...');
            if (!window.userId) {
                console.error("userId가 정의되지 않았습니다. 데이터 리스너를 시작할 수 없습니다.");
                return;
            }
            // 경로를 사용자 전용 경로로 변경
            const collectionRef = collection(window.db, "artifacts", window.appId, "users", window.userId, "sales_data");
            
            onSnapshot(collectionRef, (snapshot) => {
                window.showLoader('데이터를 처리 중입니다...');
                window.allSalesData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const date = data.date ? data.date.toDate() : null;
                    return { ...data, date: date, id: doc.id };
                });
                
                console.log("새로운 데이터가 감지되었습니다:", window.allSalesData);
                
                window.allSalesData.sort((a, b) => (a.date?.getTime() || 0) - (b.date?.getTime() || 0));
                
                renderUploadedDataList(window.allSalesData);
                renderDashboard(window.allSalesData);
                renderDetailedDashboard(window.allSalesData);
                window.hideLoader();
            }, (error) => {
                console.error("Firestore 데이터 리스너 오류:", error);
                window.hideLoader();
                const loadingElement = document.getElementById('loading');
                if (loadingElement) {
                     loadingElement.textContent = '데이터를 불러오는 데 실패했습니다.';
                     loadingElement.style.display = 'block';
                }
            });
        }
        
        // 대시보드 렌더링 함수
        window.renderDashboard = function(salesData) {
            console.log("대시보드 렌더링 시작, 데이터:", salesData);
            try {
                const loadingElement = document.getElementById('loading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }

                const reportContainer = document.getElementById('report-container');
                if (!reportContainer) {
                    console.error("Report container not found.");
                    return;
                }

                if (salesData.length === 0) {
                    reportContainer.innerHTML = '<p class="text-center text-gray-500">데이터가 없습니다. 엑셀 파일을 업로드해주세요.</p>';
                    return;
                }

                // 현재 날짜 대신 최신 데이터 날짜를 기준으로 월간 누적 계산
                const mostRecentData = salesData[salesData.length - 1];
                const mostRecentDate = mostRecentData ? mostRecentData.date : null;

                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);
                
                const yesterdayData = salesData.find(d => d.date && d.date.toLocaleDateString() === yesterday.toLocaleDateString());
                
                const currentMonthSales = mostRecentDate ? salesData
                    .filter(d => d.date && d.date.getMonth() === mostRecentDate.getMonth() && d.date.getFullYear() === mostRecentDate.getFullYear())
                    .reduce((sum, d) => sum + (d.total_sales || 0), 0) : 0;
                    
                const totalSales = salesData.reduce((sum, d) => sum + (d.total_sales || 0), 0);
                const uniqueDates = [...new Set(salesData.map(d => d.date_str))].length;
                const dailyAvg = uniqueDates > 0 ? totalSales / uniqueDates : 0;
                
                const weekdays = salesData.filter(d => d.date && d.date.getDay() !== 0 && d.date.getDay() !== 6);
                const weekendDays = salesData.filter(d => d.date && d.date.getDay() === 0 || d.date.getDay() === 6);
                
                const weekdayAvg = weekdays.length > 0 ? weekdays.reduce((sum, d) => sum + (d.total_sales || 0), 0) / weekdays.length : 0;
                const weekendAvg = weekendDays.length > 0 ? weekendDays.reduce((sum, d) => sum + (d.total_sales || 0), 0) / weekendDays.length : 0;
                
                const lastYearData = {
                    yesterday: yesterdayData ? yesterdayData.total_sales * 0.95 : 1500000,
                };
                const yesterdayGrowth = yesterdayData ? ((yesterdayData.total_sales - lastYearData.yesterday) / lastYearData.yesterday) * 100 : 0;
                const growthColor = yesterdayGrowth >= 0 ? 'text-green-500' : 'text-red-500';

                const currentDateEl = document.getElementById('current-date');
                if (currentDateEl) {
                    currentDateEl.textContent = new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                }
                
                const dailySalesEl = document.getElementById('daily-sales');
                if (dailySalesEl) {
                    dailySalesEl.textContent = yesterdayData ? yesterdayData.total_sales.toLocaleString() + '원' : '데이터 없음';
                }

                // 월간 누적 매출 및 라벨 업데이트
                const monthlyCumulativeEl = document.getElementById('monthly-cumulative');
                if (monthlyCumulativeEl) {
                    monthlyCumulativeEl.textContent = currentMonthSales > 0 ? currentMonthSales.toLocaleString() + '원' : '데이터 없음';
                }
                const currentMonthLabelEl = document.getElementById('current-month-label');
                if(currentMonthLabelEl) {
                    currentMonthLabelEl.textContent = mostRecentDate ? mostRecentDate.toLocaleDateString('ko-KR', { month: 'long' }) : '최근 데이터 없음';
                }
                
                const dailyAverageEl = document.getElementById('daily-average-sales');
                if (dailyAverageEl) {
                    dailyAverageEl.textContent = dailyAvg > 0 ? Math.round(dailyAvg).toLocaleString() + '원' : '데이터 없음';
                }

                const weekdayAverageEl = document.getElementById('weekday-average');
                if (weekdayAverageEl) {
                    weekdayAverageEl.textContent = weekdayAvg > 0 ? Math.round(weekdayAvg).toLocaleString() + '원' : '데이터 없음';
                }
                
                const weekendAverageEl = document.getElementById('weekend-average');
                if (weekendAverageEl) {
                    weekendAverageEl.textContent = weekendAvg > 0 ? Math.round(weekendAvg).toLocaleString() + '원' : '데이터 없음';
                }
                
                const dailyTransactionsEl = document.getElementById('daily-transactions');
                if (dailyTransactionsEl) {
                    dailyTransactionsEl.textContent = yesterdayData ? yesterdayData.transaction_count.toLocaleString() + '건' : '데이터 없음';
                }
                
                const averagePriceEl = document.getElementById('average-price');
                if (averagePriceEl) {
                    averagePriceEl.textContent = yesterdayData && yesterdayData.average_unit_price > 0 ? Math.round(yesterdayData.average_unit_price).toLocaleString() + '원' : '데이터 없음';
                }

                const yoyGrowthEl = document.getElementById('yoy-growth');
                if (yoyGrowthEl) {
                    yoyGrowthEl.innerHTML = `<span class="${growthColor}">${Math.round(yesterdayGrowth).toFixed(0)}%</span>`;
                }

                // 메뉴군별 매출 집계 (동적 카테고리 맵 사용)
                const menuCategorySales = {};
                for (const category in window.menuCategoryMap) {
                    menuCategorySales[category] = 0;
                }
                
                const individualMenuSales = {};

                salesData.forEach(d => {
                    if (d.menu_sales) {
                        for (const [menu, sales] of Object.entries(d.menu_sales)) {
                            let foundCategory = null;
                            for (const category in window.menuCategoryMap) {
                                if (window.menuCategoryMap[category].includes(menu)) {
                                    foundCategory = category;
                                    break;
                                }
                            }
                            if (foundCategory) {
                                menuCategorySales[foundCategory] = (menuCategorySales[foundCategory] || 0) + sales;
                            } else {
                                menuCategorySales['기타'] = (menuCategorySales['기타'] || 0) + sales;
                            }
                            individualMenuSales[menu] = (individualMenuSales[menu] || 0) + sales;
                        }
                    }
                });

                const sortedMenus = Object.entries(individualMenuSales)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 10);
                    
                renderPieChart(Object.entries(menuCategorySales));
                renderBarChart(sortedMenus);

                // '당월 매출 누적' 카드 클릭 시 상세 대시보드로 이동
                const monthlyCumulativeCard = document.getElementById('monthly-cumulative-card');
                if (monthlyCumulativeCard) {
                    monthlyCumulativeCard.onclick = () => window.showTab('detailed-dashboard');
                }
            } catch (error) {
                console.error("대시보드 렌더링 중 오류 발생:", error);
                const reportContainer = document.getElementById('report-container');
                if (reportContainer) {
                    reportContainer.innerHTML = '<p class="text-center text-red-500">데이터 표시 중 오류가 발생했습니다. 콘솔을 확인해주세요.</p>';
                }
            }
        };

        // 상세 대시보드 렌더링 함수
        window.renderDetailedDashboard = function(salesData) {
            console.log("상세 대시보드 렌더링 시작, 데이터:", salesData);
            const detailedDashboard = document.getElementById('detailed-dashboard');
            if (salesData.length === 0) {
                detailedDashboard.innerHTML = '<p class="text-center text-gray-500">데이터가 없습니다. 엑셀 파일을 업로드해주세요.</p>';
                return;
            }

            const dailySales = {};
            const menuCategorySales = {};
            for (const category in window.menuCategoryMap) {
                menuCategorySales[category] = 0;
            }

            salesData.forEach(d => {
                const dateKey = d.date_str;
                if (!dailySales[dateKey]) {
                    dailySales[dateKey] = {
                        date: d.date,
                        date_str: dateKey,
                        total_sales: 0,
                        transaction_count: 0
                    };
                }
                dailySales[dateKey].total_sales += d.total_sales;
                dailySales[dateKey].transaction_count += d.transaction_count;

                if (d.menu_sales) {
                    for (const [menu, sales] of Object.entries(d.menu_sales)) {
                        let foundCategory = null;
                        for (const cat in window.menuCategoryMap) {
                            if (window.menuCategoryMap[cat].includes(menu)) {
                                foundCategory = cat;
                                break;
                            }
                        }
                        if (foundCategory) {
                            menuCategorySales[foundCategory] = (menuCategorySales[foundCategory] || 0) + sales;
                        } else {
                            menuCategorySales['기타'] = (menuCategorySales['기타'] || 0) + sales;
                        }
                    }
                }
            });

            const dailyDataForChart = Object.values(dailySales)
                .sort((a, b) => a.date.getTime() - b.date.getTime());
            renderLineChart(dailyDataForChart);
            
            const dailyTable = document.getElementById('daily-sales-table');
            if (dailyTable) {
                let dailyTableHTML = `
                    <h4 class="text-lg font-bold mb-2">일자별 매출 목록</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md text-sm">
                            <thead>
                                <tr class="w-full bg-gray-100 text-left text-gray-600 uppercase tracking-wider">
                                    <th class="py-3 px-4 border-b-2 border-gray-200">날짜</th>
                                    <th class="py-3 px-4 border-b-2 border-gray-200">총 매출액</th>
                                    <th class="py-3 px-4 border-b-2 border-gray-200">총 건수</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                let totalSalesSum = 0;
                let totalTransactionCount = 0;

                Object.entries(dailySales).sort(([dateA], [dateB]) => new Date(dateA) - new Date(dateB)).forEach(([dateStr, data]) => {
                    const date = new Date(dateStr);
                    const dayOfWeek = date.getDay(); // 0 = 일요일, 6 = 토요일
                    let dayColorClass = '';
                    if (dayOfWeek === 6) {
                        dayColorClass = 'text-blue-500 font-bold';
                    } else if (dayOfWeek === 0) {
                        dayColorClass = 'text-red-500 font-bold';
                    }

                    dailyTableHTML += `
                        <tr class="hover:bg-gray-50 border-b border-gray-200">
                            <td class="py-3 px-4 ${dayColorClass}">${dateStr}</td>
                            <td class="py-3 px-4">${data.total_sales.toLocaleString()}원</td>
                            <td class="py-3 px-4">${data.transaction_count.toLocaleString()}건</td>
                        </tr>
                    `;
                    totalSalesSum += data.total_sales;
                    totalTransactionCount += data.transaction_count;
                });
                
                dailyTableHTML += `
                    <tr class="font-bold bg-gray-200">
                        <td class="py-3 px-4">합계</td>
                        <td class="py-3 px-4">${totalSalesSum.toLocaleString()}원</td>
                        <td class="py-3 px-4">${totalTransactionCount.toLocaleString()}건</td>
                    </tr>
                `;

                dailyTableHTML += `</tbody></table></div>`;
                dailyTable.innerHTML = dailyTableHTML;
            }

            // 메뉴군별 매출 테이블 렌더링
            const menuGroupTable = document.getElementById('menu-group-sales-table');
            if (menuGroupTable) {
                let menuGroupTableHTML = `
                    <h4 class="text-lg font-bold mb-2">메뉴군별 매출 현황<span class="text-gray-500 ml-2 text-sm font-normal">(클릭하여 상세 보기)</span></h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md text-sm">
                            <thead>
                                <tr class="w-full bg-gray-100 text-left text-gray-600 uppercase tracking-wider">
                                    <th class="py-3 px-4 border-b-2 border-gray-200">메뉴군</th>
                                    <th class="py-3 px-4 border-b-2 border-gray-200">총 매출액</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                let totalMenuSalesSum = 0;
                const sortedCategories = Object.entries(menuCategorySales).sort(([, a], [, b]) => b - a);

                sortedCategories.forEach(([category, sales]) => {
                    menuGroupTableHTML += `
                        <tr class="hover:bg-gray-50 border-b border-gray-200 cursor-pointer" onclick="showCategoryDetail('${category}')">
                            <td class="py-3 px-4">${category}</td>
                            <td class="py-3 px-4">${sales.toLocaleString()}원</td>
                        </tr>
                    `;
                    totalMenuSalesSum += sales;
                });
                
                menuGroupTableHTML += `
                    <tr class="font-bold bg-gray-200">
                        <td class="py-3 px-4">합계</td>
                        <td class="py-3 px-4">${totalMenuSalesSum.toLocaleString()}원</td>
                    </tr>
                `;

                menuGroupTableHTML += `</tbody></table></div>`;
                menuGroupTable.innerHTML = menuGroupTableHTML;
            }
        };
        
        // 특정 카테고리의 메뉴 상세 보기 모달 표시 함수
        window.showCategoryDetail = function(category) {
            const individualMenuSales = {};
            window.allSalesData.forEach(dayData => {
                for (const menu in dayData.menu_sales) {
                    let foundCategory = null;
                    for (const cat in window.menuCategoryMap) {
                        if (window.menuCategoryMap[cat].includes(menu)) {
                            foundCategory = cat;
                            break;
                        }
                    }
                    if (foundCategory === category) {
                         individualMenuSales[menu] = (individualMenuSales[menu] || 0) + dayData.menu_sales[menu];
                    }
                }
            });

            const sortedMenus = Object.entries(individualMenuSales).sort(([, a], [, b]) => b - a);
            
            const modalContent = document.getElementById('menu-detail-content');
            modalContent.innerHTML = `
                <h3 class="text-2xl font-bold mb-4">${category} 상세 매출 현황</h3>
                <div class="overflow-y-auto max-h-[400px]">
                    <table class="min-w-full bg-white rounded-lg text-sm">
                        <thead>
                            <tr class="w-full bg-gray-100 text-left text-gray-600 uppercase tracking-wider">
                                <th class="py-3 px-4 border-b-2 border-gray-200">메뉴명</th>
                                <th class="py-3 px-4 border-b-2 border-gray-200">총 매출액</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedMenus.map(([menu, sales]) => `
                                <tr class="hover:bg-gray-50 border-b border-gray-200">
                                    <td class="py-2 px-4">${menu}</td>
                                    <td class="py-2 px-4">${sales.toLocaleString()}원</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('menu-detail-modal').classList.remove('hidden');
        };

        // 카테고리 설정 모달 표시 함수
        window.showCategorySettings = function() {
            const modalContent = document.getElementById('category-settings-content');
            let html = `<h3 class="text-2xl font-bold mb-4">카테고리 설정</h3>`;
            
            const availableMenus = new Set();
            window.allSalesData.forEach(d => {
                if (d.menu_sales) {
                    Object.keys(d.menu_sales).forEach(menu => availableMenus.add(menu));
                }
            });

            let usedMenus = new Set();
            for (const category in window.menuCategoryMap) {
                window.menuCategoryMap[category].forEach(menu => usedMenus.add(menu));
            }
            const unassignedMenus = Array.from(availableMenus).filter(menu => !usedMenus.has(menu));
            unassignedMenus.sort();

            html += `<div id="unassigned-menus" class="mb-4">
                        <h4 class="text-lg font-semibold">미지정 메뉴</h4>
                        <p class="text-sm text-gray-500 mb-2">아래 메뉴들을 드래그하여 원하는 카테고리로 이동하세요.</p>
                        <div class="flex flex-wrap gap-2 p-2 bg-gray-100 rounded-lg h-24 overflow-y-auto" ondragover="event.preventDefault()" ondrop="drop(event, null)">
                            ${unassignedMenus.map(menu => `<span class="bg-gray-300 text-gray-800 text-xs px-2 py-1 rounded-full cursor-pointer" draggable="true" ondragstart="drag(event, '${menu}')">${menu}</span>`).join('')}
                        </div>
                    </div>`;

            html += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;
            for (const category in window.menuCategoryMap) {
                html += `
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <div class="flex items-center mb-2">
                            <h4 class="text-lg font-semibold text-gray-800">${category}</h4>
                            <button class="ml-auto text-red-500 hover:text-red-700" onclick="deleteCategory('${category}')">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                            </button>
                        </div>
                        <div class="flex flex-wrap gap-2 p-2 bg-white border border-dashed border-gray-300 rounded-md min-h-[60px]" ondragover="event.preventDefault()" ondrop="drop(event, '${category}')" id="category-${category}">
                            ${window.menuCategoryMap[category].map(menu => `<span class="bg-blue-200 text-blue-800 text-xs px-2 py-1 rounded-full cursor-pointer" draggable="true" ondragstart="drag(event, '${menu}')">${menu}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            html += `</div>`;
            html += `
                <div class="mt-4">
                    <input type="text" id="new-category-name" placeholder="새 카테고리 이름" class="p-2 border rounded-md">
                    <button class="ml-2 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600" onclick="addCategory()">카테고리 추가</button>
                </div>
            `;
            modalContent.innerHTML = html;
            document.getElementById('category-settings-modal').classList.remove('hidden');
        };

        // 드래그 앤 드롭 함수
        window.drag = function(ev, menuName) {
            ev.dataTransfer.setData("text", menuName);
        };

        window.drop = function(ev, categoryName) {
            ev.preventDefault();
            const menuName = ev.dataTransfer.getData("text");
            let oldCategory = null;
            for (const cat in window.menuCategoryMap) {
                if (window.menuCategoryMap[cat].includes(menuName)) {
                    oldCategory = cat;
                    break;
                }
            }
            
            if (oldCategory) {
                window.menuCategoryMap[oldCategory] = window.menuCategoryMap[oldCategory].filter(menu => menu !== menuName);
            }
            if (categoryName) {
                if (!window.menuCategoryMap[categoryName].includes(menuName)) {
                    window.menuCategoryMap[categoryName].push(menuName);
                }
            }
            showCategorySettings();
        };

        window.addCategory = function() {
            const newCategoryName = document.getElementById('new-category-name').value.trim();
            if (newCategoryName && !window.menuCategoryMap[newCategoryName]) {
                window.menuCategoryMap[newCategoryName] = [];
                showCategorySettings();
            } else if (newCategoryName) {
                showMessage('이미 존재하는 카테고리입니다.', 'bg-red-500');
            }
        };

        window.deleteCategory = function(categoryName) {
            if (categoryName === '기타') {
                showMessage('기타 카테고리는 삭제할 수 없습니다.', 'bg-red-500');
                return;
            }
            const menusToMove = window.menuCategoryMap[categoryName];
            if (menusToMove.length > 0) {
                window.menuCategoryMap['기타'] = window.menuCategoryMap['기타'].concat(menusToMove);
            }
            delete window.menuCategoryMap[categoryName];
            showCategorySettings();
        };


        // 파이 차트 렌더링 함수
        window.renderPieChart = function(data) {
            console.log("파이 차트 데이터:", data);
            const pieChartContainer = d3.select("#pie-chart-container");
            pieChartContainer.html(''); // 컨테이너 초기화
            if (data.length === 0 || d3.sum(data, d => d[1]) === 0) {
                pieChartContainer.html('<p class="text-center text-gray-500">차트를 표시할 데이터가 없습니다.</p>');
                return;
            }
            const width = 300, height = 300, radius = Math.min(width, height) / 2;
            const colors = d3.scaleOrdinal(d3.schemeCategory10);

            d3.select("#pie-chart-svg").remove();
            
            if (pieChartContainer.empty()) return;

            const svg = pieChartContainer
                .append("svg")
                .attr("id", "pie-chart-svg")
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet")
                .append("g")
                .attr("transform", `translate(${width / 2}, ${height / 2})`);

            const pie = d3.pie().value(d => d[1]);
            const path = d3.arc().outerRadius(radius - 10).innerRadius(0);
            const arc = d3.arc().outerRadius(radius - 5).innerRadius(0);

            const arcs = svg.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc");

            arcs.append("path")
                .attr("d", path)
                .attr("fill", d => colors(d.data[0]))
                .transition()
                .duration(750)
                .attrTween("d", function(d) {
                    const i = d3.interpolate(d.startAngle, d.endAngle);
                    return function(t) {
                        d.endAngle = i(t);
                        return arc(d);
                    };
                });
            
            arcs.append("text")
                .attr("transform", d => `translate(${arc.centroid(d)})`)
                .attr("text-anchor", "middle")
                .text(d => `${d.data[0]} (${Math.floor(d.data[1] / d3.sum(data, d => d[1]) * 100)}%)`)
                .style("font-size", "12px")
                .style("font-weight", "bold")
                .style("fill", "#fff")
                .style("opacity", 0)
                .transition()
                .duration(1500)
                .style("opacity", 1);
        };
        
        // 막대 차트 렌더링 함수
        window.renderBarChart = function(data) {
            console.log("막대 차트 데이터:", data);
            const barChartContainer = d3.select("#bar-chart-container");
            barChartContainer.html(''); // 컨테이너 초기화
            if (data.length === 0 || d3.max(data, d => d[1]) === 0) {
                barChartContainer.html('<p class="text-center text-gray-500">차트를 표시할 데이터가 없습니다.</p>');
                return;
            }
            
            const margin = {top: 20, right: 30, bottom: 60, left: 60};
            const svgWidth = 600, svgHeight = 400;
            const width = svgWidth - margin.left - margin.right;
            const height = svgHeight - margin.top - margin.bottom;

            d3.select("#bar-chart-svg").remove();

            if (barChartContainer.empty()) return;

            const svg = barChartContainer
                .append("svg")
                .attr("id", "bar-chart-svg")
                .attr("viewBox", `0 0 ${svgWidth} ${svgHeight}`)
                .attr("preserveAspectRatio", "xMidYMid meet")
                .append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);
            
            const x = d3.scaleBand()
                .domain(data.map(d => d[0]))
                .range([0, width])
                .padding(0.2);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d[1])]).nice()
                .range([height, 0]);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end")
                .style("font-size", "12px");

            svg.append("g")
                .call(d3.axisLeft(y).ticks(5, "s"))
                .style("font-size", "12px");
            
            svg.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d[0]))
                .attr("y", d => y(0))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(0))
                .attr("fill", "steelblue")
                .transition()
                .duration(800)
                .delay((d, i) => i * 100)
                .attr("y", d => y(d[1]))
                .attr("height", d => height - y(d[1]));

            svg.selectAll(".text")
                .data(data)
                .enter().append("text")
                .attr("class", "bar-text")
                .attr("x", d => x(d[0]) + x.bandwidth() / 2)
                .attr("y", d => y(d[1]) - 5)
                .attr("text-anchor", "middle")
                .text(d => Math.floor(d[1]).toLocaleString())
                .style("font-size", "12px")
                .style("fill", "#666")
                .style("opacity", 0)
                .transition()
                .duration(800)
                .delay((d, i) => i * 100)
                .style("opacity", 1);
        };

        // 일자별 매출 꺾은선 그래프 렌더링 함수
        window.renderLineChart = function(data) {
            console.log("꺾은선 그래프 데이터:", data);
            const lineChartContainer = d3.select("#line-chart-container");
            lineChartContainer.html('<p class="absolute top-4 right-4 text-sm text-gray-500">(단위 : 천원, VAT포함)</p>'); // 컨테이너 초기화 및 단위 문구 추가
            if (data.length < 2) {
                lineChartContainer.append('p').attr('class', 'text-center text-gray-500').text('차트를 표시할 데이터가 부족합니다 (최소 2일).');
                return;
            }
            
            const margin = {top: 20, right: 30, bottom: 60, left: 60};
            const svgWidth = 800, svgHeight = 400;
            const width = svgWidth - margin.left - margin.right;
            const height = svgHeight - margin.top - margin.bottom;

            d3.select("#line-chart-svg").remove();

            if (lineChartContainer.empty()) return;

            const svg = lineChartContainer
                .append("svg")
                .attr("id", "line-chart-svg")
                .attr("viewBox", `0 0 ${svgWidth} ${svgHeight}`)
                .attr("preserveAspectRatio", "xMidYMid meet")
                .append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);
            
            const x = d3.scaleTime()
                .domain(d3.extent(data, d => d.date))
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.total_sales)]).nice()
                .range([height, 0]);

            const line = d3.line()
                .x(d => x(d.date))
                .y(d => y(d.total_sales));

            // X 축
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%m/%d"))) // 날짜 형식 변경
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", "rotate(-45)")
                .style("font-size", "12px")
                .each(function(d) {
                    const dayOfWeek = new Date(d).getDay();
                    if (dayOfWeek === 0) { // Sunday
                        d3.select(this).style("fill", "red").style("font-weight", "bold");
                    } else if (dayOfWeek === 6) { // Saturday
                        d3.select(this).style("fill", "blue").style("font-weight", "bold");
                    }
                });


            // Y 축 (천원 단위로 표기)
            svg.append("g")
                .call(d3.axisLeft(y).ticks(5, "s").tickFormat(d => (Math.floor(d / 1000)).toLocaleString()))
                .style("font-size", "12px");
            
            // 라인 그래프
            svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 2)
                .attr("d", line);
                
            // 월평균 매출액 점선
            const avgSales = d3.mean(data, d => d.total_sales);
            if (avgSales) {
                svg.append("line")
                    .attr("x1", 0)
                    .attr("y1", y(avgSales))
                    .attr("x2", width)
                    .attr("y2", y(avgSales))
                    .attr("stroke", "#6b7280")
                    .attr("stroke-width", 1)
                    .attr("stroke-dasharray", "5,5");
                
                svg.append("text")
                    .attr("x", width)
                    .attr("y", y(avgSales))
                    .attr("dy", "-0.5em")
                    .attr("text-anchor", "end")
                    .style("font-size", "10px")
                    .style("fill", "#6b7280")
                    .text(`월평균: ${Math.floor(avgSales/1000).toLocaleString()}천원`);
            }
            
            // 최고 매출액 점 및 값 표시
            const maxSalesData = d3.max(data, d => d.total_sales);
            const maxSalesPoint = data.find(d => d.total_sales === maxSalesData);
            if (maxSalesPoint) {
                svg.append("circle")
                    .attr("cx", x(maxSalesPoint.date))
                    .attr("cy", y(maxSalesPoint.total_sales))
                    .attr("r", 5)
                    .attr("fill", "red");
                
                svg.append("text")
                    .attr("x", x(maxSalesPoint.date))
                    .attr("y", y(maxSalesPoint.total_sales))
                    .attr("dy", "-1em")
                    .attr("text-anchor", "middle")
                    .style("font-size", "12px")
                    .style("font-weight", "bold")
                    .style("fill", "red")
                    .text(`${Math.floor(maxSalesPoint.total_sales/1000).toLocaleString()}천원`);
            }
        };

        // 데이터베이스에 매출 데이터 저장 함수 (공유 데이터로 변경)
        window.saveSalesData = async function(data) {
            if (!window.db || !window.userId) {
                console.error("Firebase 또는 userId가 초기화되지 않았습니다.");
                return;
            }
            
            // 경로를 사용자 전용 경로로 변경
            const collectionRef = collection(window.db, "artifacts", window.appId, "users", window.userId, "sales_data");
            
            try {
                const q = query(collectionRef, where("date_str", "==", data.date_str), limit(1));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const docToUpdate = querySnapshot.docs[0];
                    await setDoc(doc(collectionRef, docToUpdate.id), { ...data, timestamp: serverTimestamp() }, { merge: true });
                    console.log("데이터 업데이트 성공:", docToUpdate.id);
                } else {
                    await addDoc(collectionRef, { ...data, timestamp: serverTimestamp() });
                    console.log("새로운 데이터 추가 성공");
                }
                
            } catch (error) {
                console.error("데이터 저장 또는 업데이트 오류:", error);
            }
        };

        // 파일 업로드 핸들러
        window.handleFileUpload = function(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            window.showLoader('엑셀 파일 처리 중...');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        showMessage('엑셀 파일에 데이터가 없습니다.', 'bg-red-500');
                        window.hideLoader();
                        return;
                    }

                    const headers = jsonData[0];
                    const dateCol = headers.indexOf('날짜');
                    const menuCol = headers.indexOf('메뉴별 매출');
                    const totalSalesCol = headers.indexOf('총 매출액');
                    const countCol = headers.indexOf('건수');
                    const priceCol = headers.indexOf('단가');

                    const requiredHeaders = ['날짜', '메뉴별 매출', '총 매출액', '건수', '단가'];
                    let missingHeaders = [];
                    if (dateCol === -1) missingHeaders.push('날짜');
                    if (menuCol === -1) missingHeaders.push('메뉴별 매출');
                    if (totalSalesCol === -1) missingHeaders.push('총 매출액');
                    if (countCol === -1) missingHeaders.push('건수');
                    if (priceCol === -1) missingHeaders.push('단가');
                    
                    if (missingHeaders.length > 0) {
                        showMessage(`필요한 열(${missingHeaders.join(', ')})이 누락되었습니다.`, 'bg-red-500');
                        window.hideLoader();
                        return;
                    }
                    
                    const dailyData = {};
                    const processedRows = [];
                    
                    jsonData.slice(1).forEach(row => {
                        const rowResult = { rawRow: row };
                        try {
                            if (!row || row.length <= Math.max(dateCol, menuCol, totalSalesCol, countCol, priceCol)) {
                                throw new Error("행의 데이터가 완전하지 않습니다.");
                            }

                            const dateValue = row[dateCol];
                            const date = new Date(dateValue);
                            const menuName = row[menuCol];
                            const salesAmount = parseInt(row[totalSalesCol]);
                            const transactionCount = parseInt(row[countCol]);
                            const unitPrice = parseInt(row[priceCol]);

                            if (isNaN(date.getTime())) {
                                throw new Error("날짜 형식이 올바르지 않습니다.");
                            }
                            if (isNaN(salesAmount)) {
                                throw new Error("총 매출액이 숫자가 아닙니다.");
                            }
                            if (isNaN(transactionCount)) {
                                throw new Error("건수가 숫자가 아닙니다.");
                            }
                            if (isNaN(unitPrice)) {
                                throw new Error("단가가 숫자가 아닙니다.");
                            }
                            if (!menuName || typeof menuName !== 'string') {
                                throw new Error("메뉴 이름이 올바르지 않습니다.");
                            }
                            
                            const dateStr = date.toLocaleDateString('ko-KR');

                            if (!dailyData[dateStr]) {
                                dailyData[dateStr] = {
                                    date: date,
                                    date_str: dateStr,
                                    total_sales: 0,
                                    transaction_count: 0,
                                    menu_sales: {},
                                };
                            }
                            
                            dailyData[dateStr].total_sales += salesAmount;
                            dailyData[dateStr].transaction_count += transactionCount;
                            dailyData[dateStr].menu_sales[menuName] = (dailyData[dateStr].menu_sales[menuName] || 0) + salesAmount;

                            rowResult.status = 'success';
                            rowResult.data = { date: date, total_sales: salesAmount, transaction_count: transactionCount, menu_name: menuName, unit_price: unitPrice };
                        } catch (e) {
                            rowResult.status = 'error';
                            rowResult.error = e.message;
                        }
                        processedRows.push(rowResult);
                    });
                    
                    // 평균 단가 계산
                    Object.keys(dailyData).forEach(dateStr => {
                        dailyData[dateStr].average_unit_price = dailyData[dateStr].total_sales / dailyData[dateStr].transaction_count;
                    });
                    
                    // 새로운 메뉴를 기타 카테고리에 추가
                    const allMenus = new Set();
                    Object.values(dailyData).forEach(dayData => {
                        Object.keys(dayData.menu_sales).forEach(menu => allMenus.add(menu));
                    });

                    const existingMenus = new Set();
                    for (const category in window.menuCategoryMap) {
                        window.menuCategoryMap[category].forEach(menu => existingMenus.add(menu));
                    }

                    const newMenus = Array.from(allMenus).filter(menu => !existingMenus.has(menu));
                    if (newMenus.length > 0) {
                        if (!window.menuCategoryMap['기타']) {
                             window.menuCategoryMap['기타'] = [];
                        }
                        window.menuCategoryMap['기타'] = window.menuCategoryMap['기타'].concat(newMenus);
                        saveMenuCategoryMap();
                    }

                    renderUploadStatus(processedRows);

                    const successfulUploads = Object.values(dailyData);
                    if (successfulUploads.length > 0) {
                        successfulUploads.forEach(dayData => saveSalesData(dayData));
                        showMessage(`${successfulUploads.length}일치 데이터가 성공적으로 업로드되었습니다.`, 'bg-green-500');
                    } else {
                        showMessage('업로드할 유효한 데이터가 없습니다. 형식을 확인해주세요.', 'bg-red-500');
                    }

                    event.target.value = ''; // 파일 입력 리셋
                    window.hideLoader();

                } catch (e) {
                    console.error("엑셀 파일 읽기 오류:", e);
                    showMessage('파일을 읽는 중에 오류가 발생했습니다. 파일을 다시 확인해주세요.', 'bg-red-500');
                    window.hideLoader();
                }
            };
            reader.readAsArrayBuffer(file);
        };

        // 업로드 상태 테이블 렌더링 함수
        window.renderUploadStatus = function(data) {
            const container = document.getElementById('upload-status-table');
            if (!container) {
                console.error('업로드 상태 테이블 컨테이너를 찾을 수 없습니다.');
                return;
            }
            let tableHTML = `
                <h4 class="text-lg font-bold mb-2">업로드 결과</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md text-sm">
                        <thead>
                            <tr class="w-full bg-gray-100 text-left text-gray-600 uppercase tracking-wider">
                                <th class="py-3 px-4 border-b-2 border-gray-200">데이터</th>
                                <th class="py-3 px-4 border-b-2 border-gray-200">상태</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(row => {
                const isSuccess = row.status === 'success';
                const statusColor = isSuccess ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                const statusText = isSuccess ? '성공' : `실패: ${row.error || '알 수 없는 오류'}`;
                const rowData = isSuccess ? `날짜: ${row.data.date.toLocaleDateString()}, 메뉴: ${row.data.menu_name}, 매출: ${row.data.total_sales.toLocaleString()}, 건수: ${row.data.transaction_count}, 단가: ${row.data.unit_price.toLocaleString()}` : '유효하지 않은 데이터';
                
                tableHTML += `
                    <tr class="hover:bg-gray-50 border-b border-gray-200">
                        <td class="py-3 px-4">${rowData}</td>
                        <td class="py-3 px-4">
                            <span class="inline-flex px-2 text-xs font-semibold leading-5 rounded-full ${statusColor}">${statusText}</span>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `</tbody></table></div>`;
            container.innerHTML = tableHTML;
        };
        
        // 업로드된 데이터 목록을 테이블로 렌더링하는 함수 추가
        window.renderUploadedDataList = function(salesData) {
            const container = document.getElementById('uploaded-data-list');
            if (!container) return;

            if (salesData.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 mt-4">업로드된 데이터가 없습니다.</p>';
                return;
            }
            
            let tableHTML = `
                <h4 class="text-lg font-bold mt-8 mb-2">업로드된 데이터 목록</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md text-sm">
                        <thead>
                            <tr class="w-full bg-gray-100 text-left text-gray-600 uppercase tracking-wider">
                                <th class="py-3 px-4 border-b-2 border-gray-200">날짜</th>
                                <th class="py-3 px-4 border-b-2 border-gray-200">총 매출액</th>
                                <th class="py-3 px-4 border-b-2 border-gray-200">총 건수</th>
                                <th class="py-3 px-4 border-b-2 border-gray-200">평균 단가</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            salesData.forEach(d => {
                tableHTML += `
                    <tr class="hover:bg-gray-50 border-b border-gray-200">
                        <td class="py-3 px-4">${d.date_str || '날짜 없음'}</td>
                        <td class="py-3 px-4">${d.total_sales > 0 ? d.total_sales.toLocaleString() + '원' : '매출 없음'}</td>
                        <td class="py-3 px-4">${d.transaction_count > 0 ? d.transaction_count.toLocaleString() + '건' : '건수 없음'}</td>
                        <td class="py-3 px-4">${d.average_unit_price > 0 ? Math.round(d.average_unit_price).toLocaleString() + '원' : '단가 없음'}</td>
                    </tr>
                `;
            });
            
            tableHTML += `</tbody></table></div>`;
            container.innerHTML = tableHTML;
        };

        // 모달 닫기 함수
        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        };

        // 삭제 확인 모달 표시 함수
        window.showConfirmDeleteModal = function() {
             document.getElementById('confirm-delete-modal').classList.remove('hidden');
        };
        
        // 탭 전환 함수
        window.showTab = function(tabId) {
            const tabs = ['dashboard', 'data-management', 'detailed-dashboard'];
            tabs.forEach(tab => {
                const element = document.getElementById(tab);
                if (element) {
                    element.classList.add('hidden');
                }
            });

            const selectedElement = document.getElementById(tabId);
            if (selectedElement) {
                selectedElement.classList.remove('hidden');
            }

            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                if (button.dataset.tab === tabId) {
                    button.classList.add('bg-blue-600', 'text-white');
                    button.classList.remove('bg-gray-200', 'text-gray-700');
                } else {
                    button.classList.remove('bg-blue-600', 'text-white');
                    button.classList.add('bg-gray-200', 'text-gray-700');
                }
            });
        };

        // DOMContentLoaded 이벤트 리스너
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            document.getElementById('excelFile').addEventListener('change', handleFileUpload);
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    window.showTab(button.dataset.tab);
                });
            });
            window.showTab('dashboard');
        });
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
        }
        .card {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 24px;
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        
        /* 숨겨진 파일 입력 필드 스타일 */
        #excelFile {
            display: none;
        }
        
        /* 커스텀 버튼 스타일 */
        .custom-file-upload {
            background-color: #2563eb;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.2s;
            display: inline-block;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .custom-file-upload:hover {
            background-color: #1d4ed8;
            transform: translateY(-2px);
        }

        /* 로더 스타일 */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .loader-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 모달 스타일 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 40;
        }

        .modal-container {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 90%;
            position: relative;
        }
    </style>
</head>
<body class="p-8 md:p-12 lg:p-16">
    <!-- 로딩 컨테이너 -->
    <div id="loader-container" class="loader-container hidden">
        <div class="loader-spinner mb-4"></div>
        <div id="loader-message" class="text-xl font-semibold text-gray-700">로딩 중...</div>
    </div>
    
    <div id="message-box" class="opacity-0"></div>
    
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-2">김포공항 정테이블</h1>
            <h2 class="text-2xl font-bold text-gray-700">일일 매출 보고서 (공유)</h2>
            <p class="mt-2 text-sm text-gray-500">작성자: 휴게운영팀 김지현</p>
        </header>

        <nav class="flex justify-center mb-8">
            <button data-tab="dashboard" class="tab-button px-6 py-3 font-semibold rounded-tl-lg rounded-bl-lg transition-colors duration-200">대시보드</button>
            <button data-tab="detailed-dashboard" class="tab-button px-6 py-3 font-semibold transition-colors duration-200">상세 대시보드</button>
            <button data-tab="data-management" class="tab-button px-6 py-3 font-semibold rounded-tr-lg rounded-br-lg transition-colors duration-200">데이터 관리</button>
        </nav>

        <div id="loading" class="text-center text-gray-500 text-lg my-10 hidden"></div>

        <!-- 대시보드 탭 내용 -->
        <div id="dashboard">
            <main id="report-container" class="space-y-12">
                <!-- 핵심 지표 섹션 -->
                <section>
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">핵심 지표</h3>
                    <p class="text-sm text-gray-500 mb-4">현재 날짜: <span id="current-date" class="font-bold"></span></p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card">
                            <p class="text-sm text-gray-500 mb-2">일일 매출액 (전일 기준)</p>
                            <p id="daily-sales" class="text-3xl font-extrabold text-blue-600"></p>
                        </div>
                        <div class="card">
                            <p class="text-sm text-gray-500 mb-2">일일 거래 건수 (전일 기준)</p>
                            <p id="daily-transactions" class="text-3xl font-extrabold text-blue-600"></p>
                        </div>
                        <div id="monthly-cumulative-card" class="card cursor-pointer">
                            <p class="text-sm text-gray-500 mb-2">당월(<span id="current-month-label"></span>) 매출 누적</p>
                            <p id="monthly-cumulative" class="text-3xl font-extrabold text-blue-600"></p>
                        </div>
                        <div class="card">
                            <p class="text-sm text-gray-500 mb-2">평균 단가 (전일 기준)</p>
                            <p id="average-price" class="text-3xl font-extrabold text-blue-600"></p>
                        </div>
                        <div class="card">
                            <p class="text-sm text-gray-500 mb-2">일평균 매출</p>
                            <p id="daily-average-sales" class="text-3xl font-extrabold text-blue-600"></p>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 rounded-lg bg-gray-100 flex items-center justify-center">
                        <p class="text-lg font-semibold text-gray-700">전년 대비 증감: <span id="yoy-growth" class="ml-2 font-bold text-xl"></span></p>
                    </div>
                </section>

                <!-- 요일별 평균 매출 섹션 추가 -->
                <section>
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">요일별 평균 매출</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card">
                            <p class="text-sm text-gray-500 mb-2">평일 평균 매출</p>
                            <p id="weekday-average" class="text-3xl font-extrabold text-blue-600"></p>
                        </div>
                        <div class="card">
                            <p class="text-sm text-gray-500 mb-2">주말 평균 매출</p>
                            <p id="weekend-average" class="text-3xl font-extrabold text-blue-600"></p>
                        </div>
                    </div>
                </section>
                
                <!-- 메뉴별 상세 보고서 섹션 -->
                <section>
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">메뉴별 상세 분석</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="card">
                            <h4 class="text-lg font-bold mb-4">메뉴 구분별 매출 비중</h4>
                            <div id="pie-chart-container" class="w-full aspect-square flex items-center justify-center"></div>
                        </div>
                        <div class="card">
                            <h4 class="text-lg font-bold mb-4">매출 TOP 10 메뉴</h4>
                            <div id="bar-chart-container" class="w-full aspect-video flex items-center justify-center"></div>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- 상세 대시보드 탭 내용 -->
        <div id="detailed-dashboard" class="hidden">
            <main class="space-y-12">
                <section>
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">일자별 매출 추이</h3>
                    <div class="card relative">
                        <div id="line-chart-container" class="w-full aspect-video flex items-center justify-center"></div>
                    </div>
                </section>
                <section>
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">상세 매출 현황</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="card">
                            <div id="daily-sales-table"></div>
                        </div>
                        <div class="card">
                            <div id="menu-group-sales-table"></div>
                        </div>
                    </div>
                </section>
            </main>
        </div>


        <!-- 데이터 관리 탭 내용 -->
        <div id="data-management" class="hidden">
            <section class="mb-12">
                <div class="bg-white p-6 rounded-lg shadow-md max-w-lg mx-auto text-center">
                    <h3 class="text-xl font-bold mb-4">데이터 업로드</h3>
                    <p class="text-gray-600 mb-6">다음과 같은 **열 이름**이 포함된 엑셀 파일을 업로드해 주세요.</p>
                    <ul class="text-left text-gray-700 list-disc list-inside mb-6">
                        <li>**날짜** (예: 2025-09-01)</li>
                        <li>**메뉴별 매출** (메뉴 이름)</li>
                        <li>**총 매출액** (해당 메뉴의 매출)</li>
                        <li>**건수** (메뉴별 판매 건수)</li>
                        <li>**단가** (메뉴별 단가)</li>
                    </ul>
                    <label for="excelFile" class="custom-file-upload">
                        엑셀 파일 선택
                    </label>
                    <button onclick="showCategorySettings()" class="ml-4 px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg transition-colors duration-200 hover:bg-gray-300">
                        카테고리 설정
                    </button>
                    <input type="file" id="excelFile" accept=".xlsx"/>
                    <div id="upload-status-table" class="mt-8"></div>
                </div>
            </section>
            
            <section>
                <div id="uploaded-data-list"></div>
                <div class="text-center mt-8">
                    <button onclick="showConfirmDeleteModal()" class="px-6 py-3 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition-colors duration-200">
                        모든 업로드 데이터 삭제
                    </button>
                </div>
            </section>
        </div>
    </div>

    <!-- 메뉴 상세 보기 모달 -->
    <div id="menu-detail-modal" class="modal-overlay hidden">
        <div class="modal-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="closeModal('menu-detail-modal')">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div id="menu-detail-content"></div>
        </div>
    </div>
    
    <!-- 카테고리 설정 모달 -->
    <div id="category-settings-modal" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-4">
                 <button class="text-blue-500 hover:text-blue-700 font-bold" onclick="saveMenuCategoryMap(); closeModal('category-settings-modal');">
                    <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                    저장
                 </button>
                <button class="text-gray-400 hover:text-gray-600" onclick="closeModal('category-settings-modal')">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="category-settings-content"></div>
        </div>
    </div>
    
    <!-- 삭제 확인 모달 -->
    <div id="confirm-delete-modal" class="modal-overlay hidden">
        <div class="modal-container text-center">
            <h3 class="text-2xl font-bold mb-4">데이터 삭제 확인</h3>
            <p class="mb-6 text-gray-700">모든 업로드 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.</p>
            <div class="flex justify-center space-x-4">
                <button onclick="deleteUploadedData()" class="px-6 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition-colors">
                    확인
                </button>
                <button onclick="closeModal('confirm-delete-modal')" class="px-6 py-2 bg-gray-300 text-gray-700 font-bold rounded-lg hover:bg-gray-400 transition-colors">
                    취소
                </button>
            </div>
        </div>
    </div>
</body>
</html>
